<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸­å¿ƒ - NoPotato</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* å¯¼èˆªæ æ ·å¼ */
        header {
            position: relative;
            text-align: center;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
        }

        .back-home {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            transition: var(--transition);
        }

        .back-home:hover {
            background-color: var(--primary-light);
        }

        .back-home i {
            font-size: 1.2rem;
        }

        .profile-container {
            max-width: 1000px;
            margin: 30px auto;
            padding: 2rem;
            background-color: var(--white);
            border-radius: 1rem;
            box-shadow: var(--shadow);
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--gray-light);
            padding-bottom: 1.5rem;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: 600;
            margin-right: 1.5rem;
        }
        
        .profile-info {
            flex-grow: 1;
        }
        
        .profile-info h2 {
            margin: 0 0 0.5rem 0;
            font-size: 1.8rem;
        }
        
        .profile-info .profile-email {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .profile-info .profile-date {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        .stats-section {
            margin: 2rem 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .stat-card {
            padding: 1.5rem;
            border-radius: 0.8rem;
            background-color: var(--gray-light);
            text-align: center;
        }
        
        .stat-card .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-card .stat-label {
            font-size: 0.9rem;
            color: var(--gray-dark);
        }
        
        .heatmap-section {
            margin: 2rem 0;
        }
        
        .heatmap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .date-range-selector {
            display: flex;
            gap: 0.5rem;
        }
        
        .date-input {
            padding: 0.5rem;
            border: 1px solid var(--gray-light);
            border-radius: 0.5rem;
        }
        
        .heatmap-container {
            min-height: 300px;
            border-radius: 0.8rem;
            background-color: var(--gray-light);
            padding: 1.5rem;
            position: relative;
        }
        
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }
        
        .secondary-btn {
            background-color: var(--gray-light);
            color: var(--gray-dark);
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <a href="index.html" class="back-home">
                <i class="fas fa-home"></i>
                è¿”å›ä¸»é¡µ
            </a>
            <h1>NoPotato <span class="emoji">ğŸ…</span></h1>
            <p class="subtitle">ä¸“æ³¨å·¥ä½œï¼Œé«˜æ•ˆå­¦ä¹ </p>
        </header>

        <div class="profile-container" id="profile-container">
            <div class="loading" id="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script src="api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const profileContainer = document.getElementById('profile-container');
            const loading = document.getElementById('loading');
            
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            if (!API.getToken()) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                // è·å–ç”¨æˆ·ä¿¡æ¯
                const { data: user } = await API.getCurrentUser();
                
                // è·å–é»˜è®¤ç»Ÿè®¡æ•°æ®ï¼ˆæœ€è¿‘30å¤©ï¼‰
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const today = new Date();
                
                const startDate = formatDate(thirtyDaysAgo);
                const endDate = formatDate(today);
                
                const { data: stats } = await API.getPomodoroStats({
                    start: startDate,
                    end: endDate
                });
                
                // è·å–æ—¥æœŸèŒƒå›´çš„æ•°æ®
                const { data: rangeData } = await API.exportRange(startDate, endDate);
                
                // éšè—åŠ è½½ä¸­æç¤º
                loading.style.display = 'none';
                
                // æ¸²æŸ“ç”¨æˆ·ä¿¡æ¯å’Œç»Ÿè®¡æ•°æ®
                renderProfile(user, stats, rangeData, startDate, endDate);
                
                // åˆå§‹åŒ–ä¸»é¢˜é€‰æ‹©å™¨
                initThemeSelector();
                
            } catch (error) {
                console.error('åŠ è½½ä¸ªäººä¸­å¿ƒæ•°æ®å¤±è´¥:', error);
                profileContainer.innerHTML = `
                    <div class="error-message" style="display: block">
                        åŠ è½½æ•°æ®å¤±è´¥: ${error.message || 'è¯·ç¨åå†è¯•'}
                    </div>
                `;
            }
        });
        
        // æ¸²æŸ“ä¸ªäººèµ„æ–™å’Œç»Ÿè®¡æ•°æ®
        function renderProfile(user, stats, rangeData, startDate, endDate) {
            const profileContainer = document.getElementById('profile-container');
            const createdAt = new Date(user.createdAt).toLocaleDateString('zh-CN');
            
            // è®¡ç®—æ€»ä»»åŠ¡æ•°
            const totalTasks = rangeData.tasks.length;
            const completedTasks = rangeData.tasks.filter(task => task.completed).length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // ç”ŸæˆHTML
            profileContainer.innerHTML = `
                <div class="profile-header">
                    <div class="profile-avatar">${user.username.charAt(0).toUpperCase()}</div>
                    <div class="profile-info">
                        <h2>${user.username}</h2>
                        <div class="profile-email">${user.email}</div>
                        <div class="profile-date">æ³¨å†Œæ—¶é—´: ${createdAt}</div>
                    </div>
                </div>
                
                <div class="stats-section">
                    <div class="stat-card">
                        <div class="stat-value">${stats.workPomodoros || 0}</div>
                        <div class="stat-label">å®Œæˆç•ªèŒ„æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Math.round((stats.workPomodoros * 25) / 60) || 0}</div>
                        <div class="stat-label">æ€»ä¸“æ³¨å°æ—¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${completedTasks}</div>
                        <div class="stat-label">å®Œæˆä»»åŠ¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${completionRate}%</div>
                        <div class="stat-label">ä»»åŠ¡å®Œæˆç‡</div>
                    </div>
                </div>
                
                <div class="heatmap-section">
                    <div class="heatmap-header">
                        <h3>ç•ªèŒ„å·¥ä½œçƒ­åŠ›å›¾</h3>
                        <div class="date-range-selector">
                            <input type="date" id="start-date" class="date-input" value="${startDate}">
                            <span>è‡³</span>
                            <input type="date" id="end-date" class="date-input" value="${endDate}">
                            <button id="update-heatmap" class="primary-btn">æ›´æ–°</button>
                        </div>
                    </div>
                    <div class="heatmap-container" id="heatmap-container">
                        <div id="tooltip" class="tooltip"></div>
                    </div>
                </div>
                
                <div class="theme-selector-container">
                    <div class="theme-selector-header">
                        <h3>é€‰æ‹©ä¸»é¢˜</h3>
                    </div>
                    <div class="theme-options" id="theme-options">
                        <div class="theme-option" data-theme="default">
                            <div class="theme-preview">
                                <div class="theme-preview-header" style="background-color: #ff6b6b;"></div>
                                <div class="theme-preview-body" style="background-color: #ffffff;"></div>
                            </div>
                            <div class="theme-name">ç•ªèŒ„çº¢</div>
                        </div>
                        <div class="theme-option" data-theme="forest">
                            <div class="theme-preview">
                                <div class="theme-preview-header" style="background-color: #1b998b;"></div>
                                <div class="theme-preview-body" style="background-color: #ffffff;"></div>
                            </div>
                            <div class="theme-name">æ£®æ—ç»¿</div>
                        </div>
                        <div class="theme-option" data-theme="ocean">
                            <div class="theme-preview">
                                <div class="theme-preview-header" style="background-color: #3a86ff;"></div>
                                <div class="theme-preview-body" style="background-color: #ffffff;"></div>
                            </div>
                            <div class="theme-name">æµ·æ´‹è“</div>
                        </div>
                        <div class="theme-option" data-theme="violet">
                            <div class="theme-preview">
                                <div class="theme-preview-header" style="background-color: #8338ec;"></div>
                                <div class="theme-preview-body" style="background-color: #ffffff;"></div>
                            </div>
                            <div class="theme-name">ç´«ç½—å…°</div>
                        </div>
                        <div class="theme-option" data-theme="dark">
                            <div class="theme-preview">
                                <div class="theme-preview-header" style="background-color: #bb86fc;"></div>
                                <div class="theme-preview-body" style="background-color: #121212;"></div>
                            </div>
                            <div class="theme-name">æš—é»‘æ¨¡å¼</div>
                        </div>
                    </div>
                </div>
            `;
            
            // åˆå§‹åŒ–çƒ­åŠ›å›¾
            initHeatmap(rangeData.dailyStats);
            
            // æ·»åŠ æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨äº‹ä»¶
            document.getElementById('update-heatmap').addEventListener('click', async () => {
                const newStartDate = document.getElementById('start-date').value;
                const newEndDate = document.getElementById('end-date').value;
                
                try {
                    document.getElementById('heatmap-container').innerHTML = '<div class="loading">æ›´æ–°ä¸­...</div>';
                    const { data: newRangeData } = await API.exportRange(newStartDate, newEndDate);
                    document.getElementById('heatmap-container').innerHTML = '<div id="tooltip" class="tooltip"></div>';
                    initHeatmap(newRangeData.dailyStats);
                } catch (error) {
                    console.error('æ›´æ–°çƒ­åŠ›å›¾å¤±è´¥:', error);
                    document.getElementById('heatmap-container').innerHTML = `
                        <div class="error-message" style="display: block">
                            æ›´æ–°çƒ­åŠ›å›¾å¤±è´¥: ${error.message || 'è¯·ç¨åå†è¯•'}
                        </div>
                    `;
                }
            });
        }
        
        // åˆå§‹åŒ–çƒ­åŠ›å›¾
        function initHeatmap(dailyStats) {
            // ç¡®ä¿æœ‰æ•°æ®
            if (!dailyStats || dailyStats.length === 0) {
                document.getElementById('heatmap-container').innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            // è®¾ç½®çƒ­åŠ›å›¾å°ºå¯¸
            const margin = { top: 30, right: 30, bottom: 30, left: 30 };
            const width = document.getElementById('heatmap-container').clientWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;
            
            // åˆ›å»ºSVGå…ƒç´ 
            const svg = d3.select('#heatmap-container')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // å‡†å¤‡æ•°æ®
            const data = dailyStats.map(d => ({
                date: new Date(d.date),
                value: d.workPomodoros,
                tasks: d.completedTasksCount,
                minutes: d.totalWorkMinutes
            }));
            
            // è®¡ç®—æ¯ä¸ªæ—¥æœŸçš„ä½ç½®
            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(d => d.date))
                .padding(0.1);
            
            // æ·»åŠ Xè½´
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).tickFormat(d => {
                    const date = new Date(d);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                }).tickValues(x.domain().filter((d, i) => i % 3 === 0)));
            
            // è®¡ç®—é¢œè‰²æ¯”ä¾‹
            const maxValue = d3.max(data, d => d.value) || 1;
            const color = d3.scaleLinear()
                .domain([0, maxValue / 2, maxValue])
                .range(['#f1f5f9', '#ff9c6e', '#ff4d4f']);
            
            // åˆ›å»ºçƒ­åŠ›å›¾å•å…ƒæ ¼
            svg.selectAll('rect')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', d => x(d.date))
                .attr('y', 0)
                .attr('width', x.bandwidth())
                .attr('height', height - 30)
                .style('fill', d => color(d.value))
                .style('stroke', '#fff')
                .style('stroke-width', 2)
                .on('mouseover', function(event, d) {
                    const tooltip = d3.select('#tooltip');
                    const date = d.date.toLocaleDateString('zh-CN');
                    tooltip.html(`æ—¥æœŸ: ${date}<br>ç•ªèŒ„æ•°: ${d.value}<br>å®Œæˆä»»åŠ¡: ${d.tasks}<br>å·¥ä½œæ—¶é—´: ${Math.round(d.minutes / 60)}å°æ—¶${d.minutes % 60}åˆ†é’Ÿ`)
                        .style('left', (event.pageX - document.getElementById('heatmap-container').getBoundingClientRect().left + 10) + 'px')
                        .style('top', (event.pageY - document.getElementById('heatmap-container').getBoundingClientRect().top - 40) + 'px')
                        .style('opacity', 0.9);
                })
                .on('mouseout', function() {
                    d3.select('#tooltip').style('opacity', 0);
                });
            
            // æ·»åŠ å›¾ä¾‹
            const legendWidth = 150;
            const legendHeight = 10;
            
            const legendScale = d3.scaleLinear()
                .domain([0, maxValue])
                .range([0, legendWidth]);
            
            const legendAxis = d3.axisBottom(legendScale)
                .tickSize(13)
                .ticks(3);
            
            const defs = svg.append('defs');
            const linearGradient = defs.append('linearGradient')
                .attr('id', 'linear-gradient');
            
            linearGradient.selectAll('stop')
                .data([
                    {offset: '0%', color: '#f1f5f9'},
                    {offset: '50%', color: '#ff9c6e'},
                    {offset: '100%', color: '#ff4d4f'}
                ])
                .enter().append('stop')
                .attr('offset', d => d.offset)
                .attr('stop-color', d => d.color);
            
            svg.append('g')
                .attr('transform', `translate(${width - legendWidth - 10}, ${height - 20})`)
                .append('rect')
                .attr('width', legendWidth)
                .attr('height', legendHeight)
                .style('fill', 'url(#linear-gradient)');
            
            svg.append('g')
                .attr('transform', `translate(${width - legendWidth - 10}, ${height - 20})`)
                .call(legendAxis)
                .select('.domain').remove();
            
            svg.append('text')
                .attr('x', width - legendWidth - 10)
                .attr('y', height - 30)
                .text('ç•ªèŒ„æ•°é‡')
                .style('font-size', '0.8rem');
        }
        
        // åˆå§‹åŒ–ä¸»é¢˜é€‰æ‹©å™¨
        function initThemeSelector() {
            const themeOptions = document.getElementById('theme-options');
            const currentTheme = localStorage.getItem('theme') || 'default';
            
            // è®¾ç½®å½“å‰ä¸»é¢˜
            document.documentElement.setAttribute('data-theme', currentTheme);
            
            // é«˜äº®æ˜¾ç¤ºå½“å‰ä¸»é¢˜é€‰é¡¹
            const activeOption = themeOptions.querySelector(`[data-theme="${currentTheme}"]`);
            if (activeOption) {
                activeOption.classList.add('active');
            }
            
            // æ·»åŠ ä¸»é¢˜é€‰æ‹©äº‹ä»¶
            themeOptions.addEventListener('click', (e) => {
                const themeOption = e.target.closest('.theme-option');
                if (!themeOption) return;
                
                const theme = themeOption.dataset.theme;
                
                // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                themeOptions.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.remove('active');
                });
                
                // æ·»åŠ æ–°çš„æ¿€æ´»çŠ¶æ€
                themeOption.classList.add('active');
                
                // ä¿å­˜å¹¶åº”ç”¨ä¸»é¢˜
                localStorage.setItem('theme', theme);
                document.documentElement.setAttribute('data-theme', theme);
            });
        }
        
        // æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    </script>
</body>
</html> 