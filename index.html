<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•ªèŒ„é’Ÿ - NoPotato</title>
    <link rel="stylesheet" href="styles.css">
    <!-- æ·»åŠ å­—ä½“ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ç”¨æˆ·èœå•æ ·å¼ */
        .user-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 20px;
            transition: var(--transition);
        }

        .user-info:hover {
            background-color: var(--gray-light);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow);
            width: 150px;
            display: none;
            z-index: 100;
        }

        .user-dropdown.active {
            display: block;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: var(--transition);
        }

        .dropdown-item:hover {
            background-color: var(--gray-light);
        }

        .login-btn {
            padding: 8px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: var(--transition);
        }

        .login-btn:hover {
            background-color: var(--primary-dark);
        }

        /* æ—¥å†æ ·å¼ */
        .calendar-container {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow);
            display: none;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .calendar-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .calendar-nav {
            display: flex;
            gap: 5px;
        }

        .calendar-nav-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--gray-light);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-nav-btn:hover {
            background-color: var(--gray);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 500;
            color: var(--gray-dark);
            font-size: 0.8rem;
            padding: 5px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .calendar-day:hover {
            background-color: var(--gray-light);
        }

        .calendar-day.active {
            background-color: var(--primary-color);
            color: white;
        }

        .calendar-day.has-tasks::after {
            content: "";
            position: absolute;
            bottom: 4px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--primary-color);
        }

        .calendar-day.active.has-tasks::after {
            background-color: white;
        }

        .calendar-day .day-number {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .calendar-day.today {
            border: 2px solid var(--primary-color);
        }

        .calendar-day.other-month {
            color: var(--gray);
            opacity: 0.6;
        }

        /* å†å²ä»»åŠ¡å®¹å™¨ */
        .history-tasks-container {
            margin-top: 20px;
            display: none;
        }

        .history-tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-date {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .history-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-dark);
            font-size: 1.2rem;
        }

        .no-tasks-message {
            text-align: center;
            color: var(--gray);
            padding: 15px;
        }

        /* æ¢å¤å·¦å³å¸ƒå±€ */
        main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            main {
                grid-template-columns: 1fr;
            }
        }

        /* æ—¥å†åˆ‡æ¢æŒ‰é’® */
        .calendar-toggle-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-toggle-btn:hover {
            color: var(--primary-dark);
        }

        .calendar-toggle-btn .icon {
            transition: transform 0.3s ease;
        }

        .calendar-toggle-btn.active .icon {
            transform: rotate(180deg);
        }

        /* AIç›¸å…³æ ·å¼ */
        .ai-assistant-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 100;
            border: none;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .ai-assistant-btn:hover {
            transform: scale(1.1);
            background-color: var(--primary-dark);
        }

        .ai-chat-container {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 350px;
            height: 500px;
            background-color: var(--white);
            border-radius: 15px;
            box-shadow: var(--shadow);
            z-index: 100;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .ai-chat-header {
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-chat-controls {
            display: flex;
            gap: 10px;
        }

        .ai-chat-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .ai-chat-btn:hover {
            transform: scale(1.1);
        }

        .ai-chat-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            max-width: none;
            border-radius: 0;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ai-message {
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
            word-break: break-word;
            font-size: 14px;
            line-height: 1.4;
        }

        .ai-message.user {
            background-color: var(--primary-light);
            color: var(--gray-dark);
            align-self: flex-end;
        }

        .ai-message.bot {
            background-color: var(--gray-light);
            color: var(--gray-dark);
            align-self: flex-start;
        }

        .ai-chat-input {
            padding: 15px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ai-chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--gray-light);
            border-radius: 20px;
            outline: none;
            min-width: 200px;
        }

        .ai-chat-input input:disabled {
            background-color: var(--gray-light);
            color: var(--gray);
            cursor: not-allowed;
        }

        .ai-chat-input button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-chat-input button:hover:not(:disabled) {
            background-color: var(--primary-dark);
        }

        .ai-chat-input button:disabled {
            background-color: var(--gray);
            cursor: not-allowed;
        }

        .import-logs-btn {
            background-color: #28a745 !important;
            color: white !important;
            border: none !important;
            border-radius: 20px !important;
            padding: 10px 20px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            width: auto !important;
            height: auto !important;
            flex-shrink: 0 !important;
            transition: all 0.3s ease !important;
        }

        .import-logs-btn:hover {
            background-color: #218838 !important;
            transform: translateY(-1px) !important;
        }

        .import-logs-btn:active {
            transform: translateY(0) !important;
        }

        .ai-typing {
            display: flex;
            gap: 3px;
            padding: 10px 15px;
            border-radius: 10px;
            background-color: var(--gray-light);
            color: var(--gray-dark);
            align-self: flex-start;
            width: 60px;
        }

        .ai-typing span {
            width: 8px;
            height: 8px;
            background-color: var(--gray);
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out both;
        }

        .ai-typing span:nth-child(1) {
            animation-delay: 0s;
        }

        .ai-typing span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .ai-typing span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.6);
            }
            40% {
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="doc-link">
                <a href="https://q05hlvbg0wa.feishu.cn/wiki/RQsSwioJAiohLjkiTtecL3Uan0c?from=from_copylink" target="_blank" class="doc-button">
                    <i class="fas fa-book"></i> æ–‡æ¡£
                </a>
                <a href="ranking.html" class="doc-button">
                    <i class="fas fa-trophy"></i> æ’è¡Œæ¦œ
                </a>
            </div>
            <h1>NoPotato <span class="emoji">ğŸ…</span></h1>
            <p class="subtitle">ä¸“æ³¨å·¥ä½œï¼Œé«˜æ•ˆå­¦ä¹ </p>

            <!-- ç”¨æˆ·èœå• -->
            <div class="user-menu" id="user-menu">
                <!-- ç™»å½•å‰æ˜¾ç¤º -->
                <div class="login-section" id="login-section">
                    <a href="login.html" class="login-btn">ç™»å½•</a>
                </div>

                <!-- ç™»å½•åæ˜¾ç¤º -->
                <div class="user-section" id="user-section" style="display: none;">
                    <div class="user-info" id="user-info">
                        <div class="user-avatar" id="user-avatar">U</div>
                        <span id="username">ç”¨æˆ·å</span>
                    </div>

                    <div class="user-dropdown" id="user-dropdown">
                        <div class="dropdown-item" id="profile-btn">ä¸ªäººä¸­å¿ƒ</div>
                        <div class="dropdown-item" id="logout-btn">é€€å‡ºç™»å½•</div>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <div class="timer-container">
                <div class="timer">
                    <div class="timer-display">
                        <span id="minutes">25</span>:<span id="seconds">00</span>
                    </div>
                    <div class="timer-label" id="timer-status">å·¥ä½œæ—¶é—´</div>
                </div>
                <div class="timer-controls">
                    <button id="start-btn" class="primary-btn">å¼€å§‹</button>
                    <button id="pause-btn" class="secondary-btn" disabled>æš‚åœ</button>
                    <button id="reset-btn" class="secondary-btn" disabled>é‡ç½®</button>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
            </div>

            <div class="tasks-container">
                <div class="section-header">
                    <h2>ä»Šæ—¥ä»»åŠ¡</h2>
                    <button id="add-task-btn" class="icon-btn">+ æ·»åŠ ä»»åŠ¡</button>
                </div>

                <div class="tasks-list" id="tasks-list">
                    <!-- ä»»åŠ¡ä¼šé€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </main>

        <!-- æ–°çš„å†å²è®°å½•åŒºåŸŸ -->
        <div class="history-section">
            <div class="section-header">
                <h2>å†å²è®°å½•</h2>
            </div>
            <div class="history-content">
                <!-- å·¦ä¾§æ—¥å† -->
                <div class="calendar-container" id="calendar-container">
                    <div class="calendar-header">
                        <div class="month-selector">
                            <div class="calendar-title" id="calendar-title">2023å¹´12æœˆ</div>
                            <div class="calendar-nav">
                                <button class="calendar-nav-btn" id="prev-month-btn">&lt;</button>
                                <button class="calendar-nav-btn" id="next-month-btn">&gt;</button>
                                <button class="calendar-nav-btn" id="today-btn">ä»Š</button>
                            </div>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendar-grid">
                        <!-- æ˜ŸæœŸè¡¨å¤´ -->
                        <div class="calendar-day-header">æ—¥</div>
                        <div class="calendar-day-header">ä¸€</div>
                        <div class="calendar-day-header">äºŒ</div>
                        <div class="calendar-day-header">ä¸‰</div>
                        <div class="calendar-day-header">å››</div>
                        <div class="calendar-day-header">äº”</div>
                        <div class="calendar-day-header">å…­</div>
                    </div>
                </div>

                <!-- å³ä¾§å†å²ä»»åŠ¡ -->
                <div class="history-tasks-container" id="history-tasks-container">
                    <div class="history-tasks-header">
                        <div class="history-date" id="history-date">é€‰æ‹©ä¸€ä¸ªæ—¥æœŸæŸ¥çœ‹ä»»åŠ¡</div>
                    </div>
                    <div class="tasks-list" id="history-tasks-list">
                        <!-- å†å²ä»»åŠ¡ä¼šé€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ ä»»åŠ¡å¯¹è¯æ¡† -->
        <div class="modal" id="add-task-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>æ·»åŠ æ–°ä»»åŠ¡</h3>
                    <button id="close-modal-btn" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="task-name">ä»»åŠ¡åç§°</label>
                        <input type="text" id="task-name" placeholder="è¯·è¾“å…¥ä»»åŠ¡åç§°">
                    </div>
                    <div class="form-group">
                        <label for="pomodoro-count">é¢„è®¡ç•ªèŒ„æ•°</label>
                        <input type="number" id="pomodoro-count" min="1" value="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="save-task-btn" class="primary-btn">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡å®Œæˆå¯¹è¯æ¡† -->
        <div class="modal" id="task-complete-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ä»»åŠ¡å®Œæˆ</h3>
                    <button id="close-complete-modal-btn" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <p>æ­å–œæ‚¨å®Œæˆäº†ä»»åŠ¡: <span id="completed-task-name"></span></p>
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-label">é¢„è®¡ç•ªèŒ„æ•°:</span>
                            <span id="expected-pomodoros"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">å®é™…ç•ªèŒ„æ•°:</span>
                            <span id="actual-pomodoros"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">å·®å¼‚:</span>
                            <span id="pomodoro-difference"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="confirm-complete-btn" class="primary-btn">ç¡®è®¤</button>
                </div>
            </div>
        </div>

        <!-- å®Œæˆä¸€ä¸ªç•ªèŒ„é’Ÿçš„é€šçŸ¥å¯¹è¯æ¡† -->
        <div class="modal" id="pomodoro-complete-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ç•ªèŒ„é’Ÿå®Œæˆ</h3>
                </div>
                <div class="modal-body">
                    <p>æ‚¨å·²å®Œæˆä¸€ä¸ªç•ªèŒ„é’Ÿï¼ç°åœ¨æ˜¯ä¼‘æ¯æ—¶é—´ã€‚</p>
                </div>
                <div class="modal-footer">
                    <button id="start-break-btn" class="primary-btn">å¼€å§‹ä¼‘æ¯ (5åˆ†é’Ÿ)</button>
                </div>
            </div>
        </div>

        <!-- ä¼‘æ¯æ—¶é—´ç»“æŸé€šçŸ¥å¯¹è¯æ¡† -->
        <div class="modal" id="break-complete-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ä¼‘æ¯å®Œæˆ</h3>
                </div>
                <div class="modal-body">
                    <p>ä¼‘æ¯æ—¶é—´ç»“æŸï¼å‡†å¤‡å¼€å§‹ä¸‹ä¸€ä¸ªç•ªèŒ„é’Ÿï¼Ÿ</p>
                </div>
                <div class="modal-footer">
                    <button id="start-next-pomodoro-btn" class="primary-btn">å¼€å§‹ä¸‹ä¸€ä¸ªç•ªèŒ„é’Ÿ</button>
                </div>
            </div>
        </div>

        <!-- ç™»å½•æç¤ºå¯¹è¯æ¡† -->
        <div class="modal" id="login-prompt-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>éœ€è¦ç™»å½•</h3>
                    <button id="close-login-prompt-btn" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <p>è¦ä½¿ç”¨è¯¥åŠŸèƒ½ï¼Œè¯·å…ˆç™»å½•æˆ–æ³¨å†Œè´¦å·ã€‚</p>
                </div>
                <div class="modal-footer">
                    <button id="go-login-btn" class="primary-btn">å»ç™»å½•</button>
                    <button id="go-register-btn" class="secondary-btn">å»æ³¨å†Œ</button>
                </div>
            </div>
        </div>

        <!-- é®ç½©å±‚ -->
        <div class="overlay" id="overlay"></div>
    </div>

    <script>
// è¦†ç›–API_URLï¼Œç¡®ä¿ä½¿ç”¨ç›¸å¯¹è·¯å¾„
// åŠ¨æ€è·å–APIåŸºç¡€URL
const getApiUrl = () => {
  // æ£€æµ‹ç¯å¢ƒ
  const isDevelopment = window.location.hostname === 'localhost' ||
                       window.location.hostname === '127.0.0.1' ||
                       window.location.port === '8080';

  if (isDevelopment) {
    return 'http://localhost:5000/api';
  } else {
    return '/api';  // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
  }
};

const API_URL = getApiUrl();

// ç®¡ç†APIè¯·æ±‚çš„ç±»
class API {
  static getToken() {
    return localStorage.getItem('pomo_token');
  }

  static setToken(token) {
    localStorage.setItem('pomo_token', token);
  }

  static clearToken() {
    localStorage.removeItem('pomo_token');
  }

  static getHeaders() {
    const token = this.getToken();
    const headers = {
      'Content-Type': 'application/json'
    };

    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    return headers;
  }

  static async request(endpoint, method = 'GET', data = null) {
    const url = `${API_URL}${endpoint}`;
    const options = {
      method,
      headers: this.getHeaders()
    };

    if (data && (method === 'POST' || method === 'PUT')) {
      options.body = JSON.stringify(data);
    }

    try {
      const response = await fetch(url, options);
      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.message || 'è¯·æ±‚å¤±è´¥');
      }

      return result;
    } catch (error) {
      console.error('APIè¯·æ±‚é”™è¯¯:', error);
      throw error;
    }
  }

  static async register(userData) {
    const result = await this.request('/auth/register', 'POST', userData);
    if (result.token) {
      this.setToken(result.token);
    }
    return result;
  }

  static async login(credentials) {
    const result = await this.request('/auth/login', 'POST', credentials);
    if (result.token) {
      this.setToken(result.token);
    }
    return result;
  }

  static async getCurrentUser() {
    return await this.request('/auth/me');
  }

  static async logout() {
    const result = await this.request('/auth/logout', 'POST');
    this.clearToken();
    return result;
  }

  // ä»»åŠ¡API
  static async getTasks() {
    return await this.request('/tasks');
  }

  static async getTask(id) {
    return await this.request(`/tasks/${id}`);
  }

  static async createTask(taskData) {
    return await this.request('/tasks', 'POST', taskData);
  }

  static async updateTask(id, taskData) {
    return await this.request(`/tasks/${id}`, 'PUT', taskData);
  }

  static async deleteTask(id) {
    return await this.request(`/tasks/${id}`, 'DELETE');
  }

  static async completeTask(id, data) {
    return await this.request(`/tasks/${id}/complete`, 'PUT', data);
  }

  // ç•ªèŒ„é’Ÿè®°å½•API
  static async getPomodoros(params = {}) {
    const queryString = new URLSearchParams(params).toString();
    return await this.request(`/pomodoros?${queryString}`);
  }

  static async createPomodoro(data) {
    return await this.request('/pomodoros', 'POST', data);
  }

  static async updatePomodoro(id, data) {
    return await this.request(`/pomodoros/${id}`, 'PUT', data);
  }

  static async getPomodoroStats(params = {}) {
    const queryString = new URLSearchParams(params).toString();
    return await this.request(`/pomodoros/stats?${queryString}`);
  }

  // æ•°æ®å¯¼å‡ºAPI
  static async exportDaily(date = null) {
    const params = date ? { date } : {};
    const queryString = new URLSearchParams(params).toString();
    return await this.request(`/export/daily?${queryString}`);
  }

  static async exportRange(start, end) {
    const params = { start, end };
    const queryString = new URLSearchParams(params).toString();
    return await this.request(`/export/range?${queryString}`);
  }

  // AIåŠ©æ‰‹API
  static async getAIAnalysis() {
    return await this.request('/ai/analyze', 'POST');
  }

  static async getUserLogs() {
    return await this.request('/ai/user-logs', 'GET');
  }

  static async chatWithAI(message, conversationMessages = []) {
    return await this.request('/ai/chat', 'POST', {
      message,
      conversationMessages
    });
  }

  // è·å–æ’è¡Œæ¦œæ•°æ®
  static async getRanking(period = 'week') {
    try {
      return await this.request(`/ranking?period=${period}`);
    } catch (error) {
      console.error('è·å–æ’è¡Œæ¦œæ•°æ®å¤±è´¥:', error);
      throw error;
    }
  }
}

// å¯¼å‡ºAPIç±»
window.API = API;
</script>
    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // åº”ç”¨ä¿å­˜çš„ä¸»é¢˜è®¾ç½®
            const savedTheme = localStorage.getItem('theme') || 'default';
            document.documentElement.setAttribute('data-theme', savedTheme);

            // ç”¨æˆ·èœå•ç›¸å…³å…ƒç´ 
            const userSection = document.getElementById('user-section');
            const loginSection = document.getElementById('login-section');
            const userInfo = document.getElementById('user-info');
            const userDropdown = document.getElementById('user-dropdown');
            const userAvatar = document.getElementById('user-avatar');
            const usernameElement = document.getElementById('username');
            const logoutBtn = document.getElementById('logout-btn');
            const profileBtn = document.getElementById('profile-btn');

            // æ—¥å†ç›¸å…³å…ƒç´ 
            const calendarContainer = document.getElementById('calendar-container');
            const calendarTitle = document.getElementById('calendar-title');
            const calendarGrid = document.getElementById('calendar-grid');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const todayBtn = document.getElementById('today-btn');
            const historyTasksContainer = document.getElementById('history-tasks-container');
            const historyTasksList = document.getElementById('history-tasks-list');
            const historyDate = document.getElementById('history-date');
            const historyCloseBtn = document.getElementById('history-close-btn');

            // ç™»å½•æç¤ºå¯¹è¯æ¡†
            const loginPromptModal = document.getElementById('login-prompt-modal');
            const closeLoginPromptBtn = document.getElementById('close-login-prompt-btn');
            const goLoginBtn = document.getElementById('go-login-btn');
            const goRegisterBtn = document.getElementById('go-register-btn');
            const overlay = document.getElementById('overlay');

            // å½“å‰æ—¥å†æ—¥æœŸ
            let currentDate = new Date();
            let selectedDate = new Date();
            // ç”¨äºå­˜å‚¨æ—¥å†ä¸­æœ‰ä»»åŠ¡çš„æ—¥æœŸ
            let taskDates = [];

            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            const checkUserAuth = async () => {
                try {
                    if (!API.getToken()) {
                        showLoginSection();
                        return false;
                    }

                    const response = await API.getCurrentUser();
                    if (response.success && response.data) {
                        const user = response.data;
                        showUserSection(user);
                        return true;
                    } else {
                        API.clearToken();
                        showLoginSection();
                        return false;
                    }
                } catch (error) {
                    console.error('Auth check error:', error);
                    API.clearToken();
                    showLoginSection();
                    return false;
                }
            };

            // æ˜¾ç¤ºç™»å½•åŒºåŸŸ
            const showLoginSection = () => {
                userSection.style.display = 'none';
                loginSection.style.display = 'block';
            };

            // æ˜¾ç¤ºç”¨æˆ·åŒºåŸŸ
            const showUserSection = (user) => {
                userSection.style.display = 'block';
                loginSection.style.display = 'none';

                // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
                usernameElement.textContent = user.username;
                userAvatar.textContent = user.username.charAt(0).toUpperCase();
            };

            // æ˜¾ç¤ºç™»å½•æç¤ºå¯¹è¯æ¡†
            const showLoginPrompt = () => {
                loginPromptModal.style.display = 'block';
                overlay.style.display = 'block';
            };

            // éšè—ç™»å½•æç¤ºå¯¹è¯æ¡†
            const hideLoginPrompt = () => {
                loginPromptModal.style.display = 'none';
                overlay.style.display = 'none';
            };

            // åˆå§‹åŒ–æ—¥å†
            const initCalendar = () => {
                // ç«‹å³æ˜¾ç¤ºæ—¥å†
                calendarContainer.style.display = 'block';

                // æ˜¾ç¤ºå†å²ä»»åŠ¡å®¹å™¨ï¼Œä½†æ˜¾ç¤ºé»˜è®¤æç¤º
                historyTasksContainer.style.display = 'block';

                // æ¸²æŸ“æ—¥å†
                renderCalendar(currentDate);

                // åŠ è½½ä»»åŠ¡æ—¥æœŸ
                loadTaskDates();

                // æœˆä»½å¯¼èˆªäº‹ä»¶
                prevMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar(currentDate);
                    loadTaskDates();
                });

                nextMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar(currentDate);
                    loadTaskDates();
                });

                todayBtn.addEventListener('click', () => {
                    currentDate = new Date();
                    selectedDate = new Date();
                    renderCalendar(currentDate);
                    loadTaskDates();
                });
            };

            // æ¸²æŸ“æ—¥å†
            const renderCalendar = (date) => {
                // è®¾ç½®æ—¥å†æ ‡é¢˜
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                calendarTitle.textContent = `${year}å¹´${month}æœˆ`;

                // æ¸…ç©ºæ—¥å†æ ¼å­ï¼ˆé™¤äº†è¡¨å¤´ï¼‰
                while (calendarGrid.children.length > 7) {
                    calendarGrid.removeChild(calendarGrid.lastChild);
                }

                // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
                const firstDay = new Date(year, month - 1, 1);
                const lastDay = new Date(year, month, 0);

                // è®¡ç®—éœ€è¦æ˜¾ç¤ºçš„ä¸Šä¸ªæœˆçš„å¤©æ•°
                const firstDayOfWeek = firstDay.getDay();

                // è®¡ç®—ä¸Šä¸ªæœˆçš„æœ€åå‡ å¤©
                const prevMonthLastDay = new Date(year, month - 1, 0).getDate();
                for (let i = 0; i < firstDayOfWeek; i++) {
                    const day = prevMonthLastDay - firstDayOfWeek + i + 1;
                    const dayElement = createDayElement(day, true);
                    dayElement.dataset.date = formatDate(new Date(year, month - 2, day));
                    calendarGrid.appendChild(dayElement);
                }

                // æ·»åŠ å½“æœˆçš„å¤©æ•°
                for (let i = 1; i <= lastDay.getDate(); i++) {
                    const dayElement = createDayElement(i, false);

                    // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
                    const today = new Date();
                    if (today.getFullYear() === year && today.getMonth() === month - 1 && today.getDate() === i) {
                        dayElement.classList.add('today');
                    }

                    // æ£€æŸ¥æ˜¯å¦æ˜¯é€‰ä¸­æ—¥æœŸ
                    if (selectedDate.getFullYear() === year && selectedDate.getMonth() === month - 1 && selectedDate.getDate() === i) {
                        dayElement.classList.add('active');
                    }

                    // è®¾ç½®æ—¥æœŸå±æ€§ç”¨äºç‚¹å‡»äº‹ä»¶
                    dayElement.dataset.date = formatDate(new Date(year, month - 1, i));

                    // æ£€æŸ¥æ˜¯å¦æœ‰ä»»åŠ¡
                    if (taskDates.includes(dayElement.dataset.date)) {
                        dayElement.classList.add('has-tasks');
                    }

                    calendarGrid.appendChild(dayElement);
                }

                // è®¡ç®—éœ€è¦æ˜¾ç¤ºçš„ä¸‹ä¸ªæœˆçš„å¤©æ•°
                const remainingCells = 42 - (firstDayOfWeek + lastDay.getDate());
                for (let i = 1; i <= remainingCells; i++) {
                    const dayElement = createDayElement(i, true);
                    dayElement.dataset.date = formatDate(new Date(year, month, i));
                    calendarGrid.appendChild(dayElement);
                }
            };

            // åˆ›å»ºæ—¥æœŸå…ƒç´ 
            const createDayElement = (day, isOtherMonth) => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';

                if (isOtherMonth) {
                    dayElement.classList.add('other-month');
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;

                dayElement.appendChild(dayNumber);

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                dayElement.addEventListener('click', handleDayClick);

                return dayElement;
            };

            // å¤„ç†æ—¥æœŸç‚¹å‡»äº‹ä»¶
            const handleDayClick = async (e) => {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
                if (!API.getToken()) {
                    showLoginPrompt();
                    return;
                }

                // è·å–ç‚¹å‡»çš„æ—¥æœŸ
                const dateString = e.currentTarget.dataset.date;

                // ç§»é™¤ä¹‹å‰é€‰ä¸­çš„æ ·å¼
                const prevActive = document.querySelector('.calendar-day.active');
                if (prevActive) {
                    prevActive.classList.remove('active');
                }

                // æ·»åŠ é€‰ä¸­æ ·å¼
                e.currentTarget.classList.add('active');

                // æ›´æ–°é€‰ä¸­æ—¥æœŸ
                selectedDate = new Date(dateString);

                // åŠ è½½è¯¥æ—¥æœŸçš„ä»»åŠ¡
                await loadHistoryTasks(dateString);
            };

            // åŠ è½½å†å²ä»»åŠ¡
            const loadHistoryTasks = async (dateString) => {
                try {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    historyTasksList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

                    // æ˜¾ç¤ºæ—¥æœŸ
                    const date = new Date(dateString);
                    historyDate.textContent = date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });

                    // åŠ è½½è¯¥æ—¥çš„ä»»åŠ¡
                    const response = await API.exportDaily(dateString);

                    if (response.success && response.data) {
                        const { tasks, pomodoros } = response.data;

                        // æ¸…ç©ºåˆ—è¡¨
                        historyTasksList.innerHTML = '';

                        if (tasks.length === 0) {
                            historyTasksList.innerHTML = '<div class="no-tasks-message">è¿™ä¸€å¤©æ²¡æœ‰ä»»åŠ¡è®°å½•</div>';
                            return;
                        }

                        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
                        tasks.forEach(task => {
                            const taskElement = document.createElement('div');
                            taskElement.className = `task-item ${task.completed ? 'completed' : ''}`;

                            taskElement.innerHTML = `
                                <div class="task-info">
                                    <div class="task-name">${task.taskName}</div>
                                    <div class="task-pomodoros">
                                        <span class="actual">${task.actualPomodoros}</span>
                                        /
                                        <span class="expected">${task.expectedPomodoros}</span>
                                    </div>
                                </div>
                            `;

                            historyTasksList.appendChild(taskElement);
                        });
                    }
                } catch (error) {
                    console.error('åŠ è½½å†å²ä»»åŠ¡å¤±è´¥:', error);
                    historyTasksList.innerHTML = '<div class="error-message">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•</div>';
                }
            };

            // åŠ è½½ä»»åŠ¡æ—¥æœŸ
            const loadTaskDates = async () => {
                if (!API.getToken()) return;

                try {
                    // è®¡ç®—æ—¥æœŸèŒƒå›´ï¼ˆå½“æœˆåŠå‰åä¸€ä¸ªæœˆï¼‰
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();

                    const start = new Date(year, month - 1, 1);
                    const end = new Date(year, month + 2, 0);

                    const startDate = formatDate(start);
                    const endDate = formatDate(end);

                    // è·å–æ—¥æœŸèŒƒå›´å†…çš„ä»»åŠ¡æ•°æ®
                    const response = await API.exportRange(startDate, endDate);

                    if (response.success && response.data) {
                        // æå–æœ‰ä»»åŠ¡çš„æ—¥æœŸ
                        taskDates = response.data.dailyStats
                            .filter(stat => stat.tasksCount > 0)
                            .map(stat => stat.date.split('T')[0]);

                        // é‡ç»˜æ—¥å†ï¼Œæ·»åŠ ä»»åŠ¡æ ‡è®°
                        renderCalendar(currentDate);
                    }
                } catch (error) {
                    console.error('åŠ è½½ä»»åŠ¡æ—¥æœŸå¤±è´¥:', error);
                }
            };

            // æ ¼å¼åŒ–æ—¥æœŸå‡½æ•°
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            // ç”¨æˆ·èœå•ç‚¹å‡»äº‹ä»¶
            userInfo.addEventListener('click', () => {
                userDropdown.classList.toggle('active');
            });

            // ç‚¹å‡»é¡µé¢å…¶ä»–ä½ç½®å…³é—­ä¸‹æ‹‰èœå•
            document.addEventListener('click', (e) => {
                if (!userInfo.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.classList.remove('active');
                }
            });

            // é€€å‡ºç™»å½•
            logoutBtn.addEventListener('click', async () => {
                try {
                    await API.logout();
                    API.clearToken();
                    showLoginSection();
                    window.location.reload();
                } catch (error) {
                    console.error('ç™»å‡ºå¤±è´¥:', error);
                }
            });

            // è¿›å…¥ä¸ªäººä¸­å¿ƒ
            profileBtn.addEventListener('click', () => {
                window.location.href = 'profile.html';
            });

            // ç™»å½•æç¤ºå¯¹è¯æ¡†å…³é—­æŒ‰é’®
            closeLoginPromptBtn.addEventListener('click', hideLoginPrompt);

            // å»ç™»å½•æŒ‰é’®
            goLoginBtn.addEventListener('click', () => {
                window.location.href = 'login.html';
            });

            // å»æ³¨å†ŒæŒ‰é’®
            goRegisterBtn.addEventListener('click', () => {
                window.location.href = 'register.html';
            });

            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€å¹¶åˆå§‹åŒ–æ—¥å†
            checkUserAuth().then(isLoggedIn => {
                if (isLoggedIn) {
                    initCalendar();
                }
            });
        });
    </script>

    <!-- AIåŠ©æ‰‹æŒ‰é’®å’ŒèŠå¤©çª—å£ -->
    <button class="ai-assistant-btn" id="ai-assistant-btn">
        å°No
    </button>

    <div class="ai-chat-container" id="ai-chat-container">
        <div class="ai-chat-header">
            <div class="ai-chat-title">
                å°Noï¼ˆæ­è½½DeepSeekï¼‰
            </div>
            <div class="ai-chat-controls">
                <button class="ai-chat-btn" id="ai-chat-fullscreen">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="ai-chat-btn" id="ai-chat-close">&times;</button>
            </div>
        </div>
        <div class="ai-chat-messages" id="ai-chat-messages">
            <div class="ai-message bot">
                ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ä¸“ä¸šç•ªèŒ„å·¥ä½œæ³•åŠ©æ‰‹ã€‚
            </div>
            <div class="ai-message bot">
                ğŸ“Š è¯·å…ˆç‚¹å‡»"å¯¼å…¥æ—¥å¿—"æŒ‰é’®ï¼Œæˆ‘ä¼šåˆ†æä½ çš„ä½¿ç”¨æ•°æ®ï¼Œç„¶åä¸ºä½ æä¾›ä¸ªæ€§åŒ–çš„æ—¶é—´ç®¡ç†å»ºè®®ã€‚
            </div>
        </div>
        <div class="ai-chat-input">
            <button id="import-logs-btn" class="import-logs-btn">
                ğŸ“Š å¯¼å…¥æ—¥å¿—
            </button>
            <input type="text" id="ai-chat-input-field" placeholder="è¯·å…ˆå¯¼å…¥æ—¥å¿—..." disabled>
            <button id="ai-chat-send-btn" disabled>
                å‘é€
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
        // AIåŠ©æ‰‹ç›¸å…³é€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            const aiAssistantBtn = document.getElementById('ai-assistant-btn');
            const aiChatContainer = document.getElementById('ai-chat-container');
            const aiChatClose = document.getElementById('ai-chat-close');
            const aiChatFullscreen = document.getElementById('ai-chat-fullscreen');
            const aiChatMessages = document.getElementById('ai-chat-messages');
            const aiChatInputField = document.getElementById('ai-chat-input-field');
            const aiChatSendBtn = document.getElementById('ai-chat-send-btn');
            const importLogsBtn = document.getElementById('import-logs-btn');

            // ç”¨äºå­˜å‚¨èŠå¤©è®°å½•å’Œç”¨æˆ·æ•°æ®
            let chatHistory = []; // æ˜¾ç¤ºç”¨çš„èŠå¤©å†å²
            let conversationMessages = []; // å‘é€ç»™AIçš„å®Œæ•´å¯¹è¯ä¸Šä¸‹æ–‡
            let userLogs = null;
            let isAnalyzing = false;
            let isFullscreen = false;
            let logsImported = false;

            // å…¨å±åˆ‡æ¢
            aiChatFullscreen.addEventListener('click', () => {
                isFullscreen = !isFullscreen;
                aiChatContainer.classList.toggle('fullscreen');
                aiChatFullscreen.innerHTML = isFullscreen ?
                    '<i class="fas fa-compress"></i>' :
                    '<i class="fas fa-expand"></i>';

                // å¦‚æœæ˜¯å…¨å±,è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
                if (isFullscreen) {
                    aiChatInputField.focus();
                }
            });

            // ESCé”®é€€å‡ºå…¨å±
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && isFullscreen) {
                    isFullscreen = false;
                    aiChatContainer.classList.remove('fullscreen');
                    aiChatFullscreen.innerHTML = '<i class="fas fa-expand"></i>';
                }
            });

            // å¯¼å…¥æ—¥å¿—æŒ‰é’®äº‹ä»¶
            importLogsBtn.addEventListener('click', async () => {
                if (logsImported) return;

                try {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    importLogsBtn.textContent = 'ğŸ“Š å¯¼å…¥ä¸­...';
                    importLogsBtn.disabled = true;

                    // è·å–ç”¨æˆ·æ—¥å¿—æ•°æ®
                    const response = await API.getUserLogs();
                    if (response.success && response.data) {
                        // æå–ç®€åŒ–çš„AIæ•°æ®ï¼Œåªä¿ç•™å…³é”®å­—æ®µï¼ˆä¸debug-data.htmlä¿æŒä¸€è‡´ï¼‰
                        userLogs = {
                            userInfo: response.data.userInfo,
                            statistics: response.data.statistics,
                            simplifiedRecords: response.data.aiData.pomodoroRecords.map(record => ({
                                taskTitle: record.taskTitle,
                                duration: record.duration,
                                completed: record.completed
                            }))
                        };
                        logsImported = true;

                        // éšè—å¯¼å…¥æŒ‰é’®ï¼Œå¯ç”¨èŠå¤©åŠŸèƒ½
                        importLogsBtn.style.display = 'none';
                        aiChatInputField.disabled = false;
                        aiChatInputField.placeholder = 'å’Œæˆ‘èŠèŠä½ çš„æ—¶é—´ç®¡ç†å§...';
                        aiChatSendBtn.disabled = false;

                        // åˆå§‹åŒ–å¯¹è¯ä¸Šä¸‹æ–‡
                        initializeConversation();

                        // å‘é€åˆå§‹åˆ†ææ¶ˆæ¯
                        showTypingIndicator();

                        const analysisMessage = "è¯·åŸºäºæˆ‘çš„ä½¿ç”¨æ•°æ®ï¼Œä¸ºæˆ‘æä¾›ä¸ªæ€§åŒ–çš„æ—¶é—´ç®¡ç†åˆ†æå’Œå»ºè®®ã€‚";

                        // è°ƒç”¨AIåˆ†æ
                        const aiResponse = await API.chatWithAI(analysisMessage, conversationMessages);
                        hideTypingIndicator();

                        if (aiResponse.success && aiResponse.data) {
                            addMessageToChat('bot', aiResponse.data.message);
                            // å°†AIå›å¤æ·»åŠ åˆ°å¯¹è¯ä¸Šä¸‹æ–‡
                            conversationMessages.push({
                                role: "assistant",
                                content: aiResponse.data.message
                            });
                        } else {
                            const fallbackMessage = 'æ•°æ®åˆ†æå®Œæˆï¼ç°åœ¨ä½ å¯ä»¥å‘æˆ‘æé—®å…³äºæ—¶é—´ç®¡ç†çš„ä»»ä½•é—®é¢˜ã€‚';
                            addMessageToChat('bot', fallbackMessage);
                            conversationMessages.push({
                                role: "assistant",
                                content: fallbackMessage
                            });
                        }

                        // æ˜¾ç¤ºæ•°æ®æ‘˜è¦
                        const summaryMessage = `ğŸ“Š æ•°æ®å¯¼å…¥æˆåŠŸï¼

ğŸ¯ åŸºæœ¬ä¿¡æ¯ï¼š
â€¢ ä½¿ç”¨å¤©æ•°ï¼š${userLogs.userInfo.totalDays}å¤©
â€¢ æ€»ç•ªèŒ„é’Ÿï¼š${userLogs.statistics.totalPomodoros}ä¸ª
â€¢ ä»»åŠ¡å®Œæˆç‡ï¼š${userLogs.statistics.completionRate}
â€¢ æ—¥å‡ç•ªèŒ„é’Ÿï¼š${userLogs.statistics.averagePomodorosPerDay}ä¸ª

ç°åœ¨ä½ å¯ä»¥å‘æˆ‘æé—®ä»»ä½•å…³äºæ—¶é—´ç®¡ç†çš„é—®é¢˜ï¼`;

                        addMessageToChat('bot', summaryMessage);

                    } else {
                        throw new Error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥');
                    }
                } catch (error) {
                    console.error('å¯¼å…¥æ—¥å¿—å¤±è´¥:', error);
                    addMessageToChat('bot', 'æŠ±æ­‰ï¼Œå¯¼å…¥æ•°æ®æ—¶å‡ºç°é—®é¢˜ã€‚è¯·ç¨åé‡è¯•ã€‚');
                    importLogsBtn.textContent = 'ğŸ“Š å¯¼å…¥æ—¥å¿—';
                    importLogsBtn.disabled = false;
                }
            });

            // æ‰“å¼€èŠå¤©çª—å£
            aiAssistantBtn.addEventListener('click', () => {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
                if (!API.getToken()) {
                    showLoginPrompt();
                    return;
                }

                // å¦‚æœçª—å£å·²ç»æ˜¾ç¤ºï¼Œç›´æ¥è¿”å›
                if (aiChatContainer.style.display === 'flex') {
                    return;
                }

                aiChatContainer.style.display = 'flex';

                // é‡ç½®çŠ¶æ€ï¼ˆå¦‚æœéœ€è¦ï¼‰
                if (!logsImported) {
                    importLogsBtn.style.display = 'block';
                    aiChatInputField.disabled = true;
                    aiChatSendBtn.disabled = true;
                }
            });

            // å…³é—­èŠå¤©çª—å£
            aiChatClose.addEventListener('click', () => {
                aiChatContainer.style.display = 'none';
            });

            // å‘é€æ¶ˆæ¯
            aiChatSendBtn.addEventListener('click', sendMessage);

            // æŒ‰å›è½¦å‘é€æ¶ˆæ¯
            aiChatInputField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // å‘é€æ¶ˆæ¯å‡½æ•°
            function sendMessage() {
                const message = aiChatInputField.value.trim();
                if (!message || !logsImported) return;

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©çª—å£
                addMessageToChat('user', message);

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯ä¸Šä¸‹æ–‡
                conversationMessages.push({
                    role: "user",
                    content: message
                });

                // æ¸…ç©ºè¾“å…¥æ¡†
                aiChatInputField.value = '';

                // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥çŠ¶æ€
                showTypingIndicator();

                // ä½¿ç”¨APIç±»å‘é€è¯·æ±‚ï¼Œä¼ é€’å®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡
                API.chatWithAI(message, conversationMessages)
                    .then(response => {
                        hideTypingIndicator();
                        if (response.success && response.data) {
                            addMessageToChat('bot', response.data.message);
                            // å°†AIå›å¤æ·»åŠ åˆ°å¯¹è¯ä¸Šä¸‹æ–‡
                            conversationMessages.push({
                                role: "assistant",
                                content: response.data.message
                            });
                        } else {
                            const fallbackMessage = 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤ï¼Œè¯·ç¨åå†è¯•ã€‚';
                            addMessageToChat('bot', fallbackMessage);
                            conversationMessages.push({
                                role: "assistant",
                                content: fallbackMessage
                            });
                        }
                    })
                    .catch(error => {
                        console.error('AIèŠå¤©è¯·æ±‚å¤±è´¥:', error);
                        hideTypingIndicator();
                        const errorMessage = 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤ï¼Œè¯·ç¨åå†è¯•ã€‚';
                        addMessageToChat('bot', errorMessage);
                        conversationMessages.push({
                            role: "assistant",
                            content: errorMessage
                        });
                    });

                // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
                aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
            }

            // åˆå§‹åŒ–å¯¹è¯ä¸Šä¸‹æ–‡
            function initializeConversation() {
                // æ¸…ç©ºä¹‹å‰çš„å¯¹è¯
                conversationMessages = [];

                // ç”Ÿæˆç®€åŒ–çš„ç•ªèŒ„é’Ÿè®°å½•ä¿¡æ¯ï¼ˆåªåŒ…å«ä¸‰ä¸ªå…³é”®å­—æ®µï¼‰
                const simplifiedRecordsDetails = userLogs.simplifiedRecords.map((record, index) =>
                    `${index + 1}. "${record.taskTitle}" - ${record.duration}åˆ†é’Ÿ - ${record.completed ? 'âœ…å·²å®Œæˆ' : 'âŒæœªå®Œæˆ'}`
                ).join('\n');

                // è®¾ç½®ç³»ç»Ÿæç¤ºè¯
                const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç•ªèŒ„å·¥ä½œæ³•æ—¶é—´ç®¡ç†åŠ©æ‰‹å°Noã€‚ä½ çš„ä»»åŠ¡æ˜¯åŸºäºç”¨æˆ·çš„å®é™…ä½¿ç”¨æ•°æ®ï¼Œæä¾›ä¸ªæ€§åŒ–çš„æ—¶é—´ç®¡ç†å»ºè®®å’Œåˆ†æã€‚

è¯·éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š
1. åŸºäºç”¨æˆ·çš„çœŸå®æ•°æ®è¿›è¡Œåˆ†æå’Œå»ºè®®
2. æä¾›å…·ä½“ã€å¯æ“ä½œçš„å»ºè®®
3. ä¿æŒå‹å¥½ã€é¼“åŠ±çš„è¯­è°ƒ
4. å›ç­”è¦ç®€æ´æ˜äº†ï¼Œä¸è¶…è¿‡200å­—
5. é‡ç‚¹å…³æ³¨æ•ˆç‡æå‡å’Œä¹ æƒ¯å…»æˆ
6. è®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹ï¼Œä¿æŒä¸Šä¸‹æ–‡è¿è´¯æ€§

=== ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ ===
- ç”¨æˆ·åï¼š${userLogs.userInfo.username}
- ä½¿ç”¨å¤©æ•°ï¼š${userLogs.userInfo.totalDays}å¤©
- æ³¨å†Œæ—¶é—´ï¼š${new Date(userLogs.userInfo.joinDate).toLocaleDateString('zh-CN')}

=== ç»Ÿè®¡æ‘˜è¦ ===
- æ€»ä»»åŠ¡æ•°ï¼š${userLogs.statistics.totalTasks}ä¸ª
- å·²å®Œæˆä»»åŠ¡ï¼š${userLogs.statistics.completedTasks}ä¸ª
- ä»»åŠ¡å®Œæˆç‡ï¼š${userLogs.statistics.completionRate}
- æ€»ç•ªèŒ„é’Ÿï¼š${userLogs.statistics.totalPomodoros}ä¸ª
- æ—¥å‡ç•ªèŒ„é’Ÿï¼š${userLogs.statistics.averagePomodorosPerDay}ä¸ª

=== ç®€åŒ–çš„ç•ªèŒ„é’Ÿè®°å½• (${userLogs.simplifiedRecords.length}æ¡) ===
${simplifiedRecordsDetails}

åŸºäºä»¥ä¸Šæ•°æ®ï¼Œä½ å¯ä»¥ä¸ºç”¨æˆ·æä¾›æ—¶é—´ç®¡ç†å»ºè®®ã€æ•ˆç‡åˆ†æå’Œå·¥ä½œä¹ æƒ¯ä¼˜åŒ–å»ºè®®ã€‚`;

                conversationMessages.push({
                    role: "system",
                    content: systemPrompt
                });

                console.log('ğŸ¤– å¯¹è¯ä¸Šä¸‹æ–‡å·²åˆå§‹åŒ–ï¼Œä½¿ç”¨ç®€åŒ–çš„ç”¨æˆ·æ•°æ®');
                console.log('ğŸ… ç®€åŒ–è®°å½•æ•°é‡:', userLogs.simplifiedRecords.length);
                console.log('ğŸ“ ç³»ç»Ÿæç¤ºè¯é•¿åº¦:', systemPrompt.length);
                console.log('ğŸ“‹ ç®€åŒ–è®°å½•ç¤ºä¾‹:', simplifiedRecordsDetails.substring(0, 200) + '...');
            }

            // è¯·æ±‚AIåˆ†ææ•°æ®
            function requestAIAnalysis() {
                // å¦‚æœæ­£åœ¨åˆ†æä¸­ï¼Œç›´æ¥è¿”å›
                if (isAnalyzing) return;

                // è®¾ç½®åˆ†æçŠ¶æ€
                isAnalyzing = true;

                // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥çŠ¶æ€
                showTypingIndicator();

                API.getAIAnalysis()
                    .then(response => {
                        if (response.success && response.data) {
                            hideTypingIndicator();

                            const analysis = response.data.analysis;
                            const stats = response.data.stats;

                            // æ·»åŠ åˆ†æç»“æœåˆ°èŠå¤©
                            addMessageToChat('bot', analysis);

                            // æ›´æ–°ç¼“å­˜
                            window.aiAnalysisCache = {
                                stats: stats,
                                analysis: analysis,
                                timestamp: Date.now()
                            };
                        }
                    })
                    .catch(error => {
                        console.error('AIåˆ†æè¯·æ±‚å¤±è´¥:', error);
                        hideTypingIndicator();
                        addMessageToChat('bot', 'æˆ‘å·²å‡†å¤‡å¥½å›ç­”ä½ çš„é—®é¢˜ã€‚');
                    })
                    .finally(() => {
                        // é‡ç½®åˆ†æçŠ¶æ€
                        isAnalyzing = false;
                    });
            }

            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
            function addMessageToChat(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `ai-message ${role}`;

                // å¤„ç†æ¢è¡Œ
                messageDiv.innerHTML = content.replace(/\n/g, '<br>');

                aiChatMessages.appendChild(messageDiv);

                // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
                aiChatMessages.scrollTop = aiChatMessages.scrollHeight;

                // æ·»åŠ åˆ°å†å²è®°å½•
                chatHistory.push({ role, content });
            }

            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
            function showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'ai-typing';
                typingDiv.id = 'ai-typing';

                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('span');
                    typingDiv.appendChild(dot);
                }

                aiChatMessages.appendChild(typingDiv);
                aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
            }

            // éšè—æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
            function hideTypingIndicator() {
                const typingIndicator = document.getElementById('ai-typing');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
        });
    </script>
</body>
</html>